'use strict';

var _ava = require('ava');

var _ava2 = _interopRequireDefault(_ava);

var _CreateEntityReducer = require('../CreateEntityReducer');

var _normalizr = require('normalizr');

var _immutable = require('immutable');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

//
// Schemas
//


var SubredditSchema = new _normalizr.Schema('subreddit', { idAttribute: 'fullnameId' });
var AuthorSchema = new _normalizr.Schema('author', { idAttribute: 'fullnameId' });
var TopListingSchema = new _normalizr.Schema('topListings', { idAttribute: 'fullnameId' });

TopListingSchema.define({
    author: AuthorSchema
});

SubredditSchema.define({
    topListings: (0, _normalizr.arrayOf)(TopListingSchema)
});

var EntitySchema = {
    subreddit: SubredditSchema
};

(0, _ava2.default)('CreateEntityReducer', function (tt) {

    var schemaMap = {
        mainSchema: EntitySchema,
        TEST_RECEIVE: EntitySchema
    };

    var EntityReducer = (0, _CreateEntityReducer.createEntityReducer)(schemaMap, function (key, value) {
        return value;
    });

    var exampleAction = {
        type: "myType"
    };

    tt.true((0, _immutable.is)(EntityReducer(undefined, exampleAction).get('_schema'), (0, _immutable.Map)(schemaMap)), 'Immutable version of schema is returned under _schema when reducer is called with no existing state');

    tt.true((0, _immutable.is)(EntityReducer(undefined, exampleAction).get('_result'), (0, _immutable.Map)()), '_result is empty  when reducer is called with no existing state');

    tt.true(EntityReducer(undefined, { type: 'TEST_FETCH' }).getIn(['_requestState', 'TEST_FETCH', 'fetch']), '_requestState.fetch is true when action type ends with _FETCH');

    tt.false(EntityReducer(undefined, exampleAction).getIn(['_requestState', 'myType', 'fetch']), '_requestState.fetch is false when action type does not end with _FETCH');

    tt.is(EntityReducer(undefined, { type: 'TEST_ERROR', payload: 'errorPayload' }).getIn(['_requestState', 'TEST_ERROR', 'error']), 'errorPayload', '_requestState.error equals payload when action type ends with _ERROR');

    tt.is(EntityReducer(undefined, exampleAction).getIn(['_requestState', 'myType', 'error']), null, '_requestState.error equals is null when action type does not end with _ERROR');

    var exampleState = (0, _immutable.fromJS)({
        thing: {
            abc: '123'
        }
    });

    tt.true((0, _immutable.is)(EntityReducer(exampleState, exampleAction).get('thing'), (0, _immutable.fromJS)({ abc: '123' })), 'data on state is unchanged when not receiving data');

    var exampleStateWithResults = (0, _immutable.fromJS)({
        thing: {
            abc: '123'
        },
        _result: {
            TEST_FETCH: ['xyz'],
            TEST_OTHER_FETCH: ['xyz']
        }
    });

    tt.true((0, _immutable.is)(EntityReducer(exampleStateWithResults, exampleAction).get('_result'), exampleStateWithResults.get('_result')), 'state._result is unchanged when not receiving data');

    tt.true((0, _immutable.is)(EntityReducer(exampleStateWithResults, { type: 'TEST_FETCH' }).get('_result'), exampleStateWithResults.get('_result').delete('TEST_FETCH')), 'state._result.TYPE is deleted when TYPE is fetched');

    var exampleActionNoResultReset = {
        type: 'TEST_FETCH',
        meta: {
            resultResetOnFetch: false
        }
    };

    tt.true((0, _immutable.is)(EntityReducer(exampleStateWithResults, exampleActionNoResultReset).get('_result'), exampleStateWithResults.get('_result')), 'state._result.TYPE is unchanged when a type is fetched AND meta.resultResetOnFetch is true');

    var examplePayload = {
        subreddit: {
            name: "MechanicalKeyboards",
            fullnameId: "MK",
            topListings: [{
                "fullnameId": "CT",
                "title": "Cool title"
            }, {
                "fullnameId": "NT",
                "title": "Nice title"
            }]
        }
    };

    var exampleReceiveAction = {
        type: 'TEST_RECEIVE',
        payload: examplePayload
    };

    tt.is(EntityReducer(exampleState, exampleReceiveAction).getIn(['_result', 'TEST_RECEIVE', 'subreddit']), 'MK', 'Normalized results are stored in state under _result.ACTIONNAME.KEY');

    tt.true((0, _immutable.is)(EntityReducer(exampleState, exampleReceiveAction).getIn(['subreddit', 'MK']).delete('topListings'), (0, _immutable.fromJS)(examplePayload.subreddit).delete('topListings')), 'Normalized entities are stored in state under ENTITYNAME.ID');

    tt.true((0, _immutable.is)(EntityReducer(exampleState, exampleReceiveAction).getIn(['topListings', 'NT']), (0, _immutable.fromJS)(examplePayload.subreddit.topListings[1])), 'Normalized nested entities are stored in state under ENTITYNAME.ID');

    var mergeExamplePayloadOne = {
        subreddit: {
            name: "MechanicalKeyboards",
            code: "123",
            fullnameId: "MK",
            topListings: [{
                "fullnameId": "CT",
                "title": "Cool title"
            }, {
                "fullnameId": "NT",
                "title": "Nice title"
            }]
        }
    };

    var mergeExampleReceiveActionOne = {
        type: 'TEST_RECEIVE',
        payload: mergeExamplePayloadOne
    };

    var mergeExamplePayloadTwo = {
        subreddit: {
            name: "MechanicalKeyboards!",
            fullnameId: "MK",
            topListings: [{
                "fullnameId": "NT",
                "title": "Nice title!"
            }, {
                "fullnameId": "GL",
                "title": "Good luck"
            }]
        }
    };

    var mergeExampleReceiveActionTwo = {
        type: 'TEST_RECEIVE',
        payload: mergeExamplePayloadTwo
    };

    var mergeStateOne = EntityReducer(exampleState, mergeExampleReceiveActionOne);
    var mergeStateTwo = EntityReducer(mergeStateOne, mergeExampleReceiveActionTwo);

    tt.true((0, _immutable.is)(mergeStateTwo.getIn(['subreddit', 'MK']).delete('topListings'), (0, _immutable.fromJS)(mergeExamplePayloadTwo.subreddit).delete('topListings')), 'Receiving updated info for an entity will replace entity data');

    tt.true((0, _immutable.is)(mergeStateTwo.getIn(['topListings', 'NT']), (0, _immutable.fromJS)(mergeExamplePayloadTwo.subreddit.topListings[0])), 'Receiving updated info for an entity will replace nested entity data');

    tt.true((0, _immutable.is)(mergeStateTwo.getIn(['topListings', 'CT']), (0, _immutable.fromJS)(mergeExamplePayloadOne.subreddit.topListings[0])), 'Once an entity is received, its entity data is retained even if subsequent received entities dont contain it');

    tt.true((0, _immutable.is)(mergeStateTwo.getIn(['topListings', 'GL']), (0, _immutable.fromJS)(mergeExamplePayloadTwo.subreddit.topListings[1])), 'Newly received nested entites are merged into their entity container');
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9fX3Rlc3RzX18vQ3JlYXRlRW50aXR5UmVkdWNlci10ZXN0LmpzIl0sIm5hbWVzIjpbIlN1YnJlZGRpdFNjaGVtYSIsImlkQXR0cmlidXRlIiwiQXV0aG9yU2NoZW1hIiwiVG9wTGlzdGluZ1NjaGVtYSIsImRlZmluZSIsImF1dGhvciIsInRvcExpc3RpbmdzIiwiRW50aXR5U2NoZW1hIiwic3VicmVkZGl0Iiwic2NoZW1hTWFwIiwibWFpblNjaGVtYSIsIlRFU1RfUkVDRUlWRSIsIkVudGl0eVJlZHVjZXIiLCJrZXkiLCJ2YWx1ZSIsImV4YW1wbGVBY3Rpb24iLCJ0eXBlIiwidHQiLCJ0cnVlIiwidW5kZWZpbmVkIiwiZ2V0IiwiZ2V0SW4iLCJmYWxzZSIsImlzIiwicGF5bG9hZCIsImV4YW1wbGVTdGF0ZSIsInRoaW5nIiwiYWJjIiwiZXhhbXBsZVN0YXRlV2l0aFJlc3VsdHMiLCJfcmVzdWx0IiwiVEVTVF9GRVRDSCIsIlRFU1RfT1RIRVJfRkVUQ0giLCJkZWxldGUiLCJleGFtcGxlQWN0aW9uTm9SZXN1bHRSZXNldCIsIm1ldGEiLCJyZXN1bHRSZXNldE9uRmV0Y2giLCJleGFtcGxlUGF5bG9hZCIsIm5hbWUiLCJmdWxsbmFtZUlkIiwiZXhhbXBsZVJlY2VpdmVBY3Rpb24iLCJtZXJnZUV4YW1wbGVQYXlsb2FkT25lIiwiY29kZSIsIm1lcmdlRXhhbXBsZVJlY2VpdmVBY3Rpb25PbmUiLCJtZXJnZUV4YW1wbGVQYXlsb2FkVHdvIiwibWVyZ2VFeGFtcGxlUmVjZWl2ZUFjdGlvblR3byIsIm1lcmdlU3RhdGVPbmUiLCJtZXJnZVN0YXRlVHdvIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQTtBQUNBO0FBQ0E7OztBQUdBLElBQUlBLGtCQUFrQixzQkFBVyxXQUFYLEVBQXdCLEVBQUNDLGFBQWEsWUFBZCxFQUF4QixDQUF0QjtBQUNBLElBQUlDLGVBQWUsc0JBQVcsUUFBWCxFQUFxQixFQUFDRCxh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QUFkLENBQXBCLEVBQXlDVyxNQUF6QyxDQUFnRCxhQUFoRCxDQURKLEVBRUksdUJBQU9XLHVCQUF1Qm5DLFNBQTlCLEVBQXlDd0IsTUFBekMsQ0FBZ0QsYUFBaEQsQ0FGSixDQURKLEVBS0ksK0RBTEo7O0FBUUFmLE9BQUdDLElBQUgsQ0FDSSxtQkFDSTRCLGNBQWN6QixLQUFkLENBQW9CLENBQUMsYUFBRCxFQUFnQixJQUFoQixDQUFwQixDQURKLEVBRUksdUJBQU9zQix1QkFBdUJuQyxTQUF2QixDQUFpQ0YsV0FBakMsQ0FBNkMsQ0FBN0MsQ0FBUCxDQUZKLENBREosRUFLSSxzRUFMSjs7QUFRQVcsT0FBR0MsSUFBSCxDQUNJLG1CQUNJNEIsY0FBY3pCLEtBQWQsQ0FBb0IsQ0FBQyxhQUFELEVBQWdCLElBQWhCLENBQXBCLENBREosRUFFSSx1QkFBT21CLHVCQUF1QmhDLFNBQXZCLENBQWlDRixXQUFqQyxDQUE2QyxDQUE3QyxDQUFQLENBRkosQ0FESixFQUtJLDhHQUxKOztBQVFBVyxPQUFHQyxJQUFILENBQ0ksbUJBQ0k0QixjQUFjekIsS0FBZCxDQUFvQixDQUFDLGFBQUQsRUFBZ0IsSUFBaEIsQ0FBcEIsQ0FESixFQUVJLHVCQUFPc0IsdUJBQXVCbkMsU0FBdkIsQ0FBaUNGLFdBQWpDLENBQTZDLENBQTdDLENBQVAsQ0FGSixDQURKLEVBS0ksc0VBTEo7QUFRSCxDQTlPRCIsImZpbGUiOiJDcmVhdGVFbnRpdHlSZWR1Y2VyLXRlc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdGVzdCBmcm9tICdhdmEnO1xuaW1wb3J0IHtjcmVhdGVFbnRpdHlSZWR1Y2VyfSBmcm9tICcuLi9DcmVhdGVFbnRpdHlSZWR1Y2VyJztcbmltcG9ydCB7U2NoZW1hLCBhcnJheU9mfSBmcm9tICdub3JtYWxpenInO1xuaW1wb3J0IHtpcywgZnJvbUpTLCBNYXB9IGZyb20gJ2ltbXV0YWJsZSc7XG5cbi8vXG4vLyBTY2hlbWFzXG4vL1xuXG5cbnZhciBTdWJyZWRkaXRTY2hlbWEgPSBuZXcgU2NoZW1hKCdzdWJyZWRkaXQnLCB7aWRBdHRyaWJ1dGU6ICdmdWxsbmFtZUlkJ30pO1xudmFyIEF1dGhvclNjaGVtYSA9IG5ldyBTY2hlbWEoJ2F1dGhvcicsIHtpZEF0dHJpYnV0ZTogJ2Z1bGxuYW1lSWQnfSk7XG52YXIgVG9wTGlzdGluZ1NjaGVtYSA9IG5ldyBTY2hlbWEoJ3RvcExpc3RpbmdzJywge2lkQXR0cmlidXRlOiAnZnVsbG5hbWVJZCd9KTtcblxuVG9wTGlzdGluZ1NjaGVtYS5kZWZpbmUoe1xuICAgIGF1dGhvcjogQXV0aG9yU2NoZW1hXG59KTtcblxuU3VicmVkZGl0U2NoZW1hLmRlZmluZSh7XG4gICAgdG9wTGlzdGluZ3M6IGFycmF5T2YoVG9wTGlzdGluZ1NjaGVtYSlcbn0pO1xuXG5jb25zdCBFbnRpdHlTY2hlbWEgPSB7XG4gICAgc3VicmVkZGl0OiBTdWJyZWRkaXRTY2hlbWFcbn1cblxudGVzdCgnQ3JlYXRlRW50aXR5UmVkdWNlcicsIHR0ID0+IHtcblxuICAgIGNvbnN0IHNjaGVtYU1hcCA9IHtcbiAgICAgICAgbWFpblNjaGVtYTogRW50aXR5U2NoZW1hLFxuICAgICAgICBURVNUX1JFQ0VJVkU6IEVudGl0eVNjaGVtYVxuICAgIH07XG5cbiAgICBjb25zdCBFbnRpdHlSZWR1Y2VyID0gY3JlYXRlRW50aXR5UmVkdWNlcihzY2hlbWFNYXAsIChrZXksIHZhbHVlKSA9PiB2YWx1ZSk7XG5cbiAgICBjb25zdCBleGFtcGxlQWN0aW9uID0ge1xuICAgICAgICB0eXBlOiBcIm15VHlwZVwiXG4gICAgfTtcblxuICAgIHR0LnRydWUoXG4gICAgICAgIGlzKFxuICAgICAgICAgICAgRW50aXR5UmVkdWNlcih1bmRlZmluZWQsIGV4YW1wbGVBY3Rpb24pLmdldCgnX3NjaGVtYScpLFxuICAgICAgICAgICAgTWFwKHNjaGVtYU1hcClcbiAgICAgICAgKSxcbiAgICAgICAgJ0ltbXV0YWJsZSB2ZXJzaW9uIG9mIHNjaGVtYSBpcyByZXR1cm5lZCB1bmRlciBfc2NoZW1hIHdoZW4gcmVkdWNlciBpcyBjYWxsZWQgd2l0aCBubyBleGlzdGluZyBzdGF0ZSdcbiAgICApO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBFbnRpdHlSZWR1Y2VyKHVuZGVmaW5lZCwgZXhhbXBsZUFjdGlvbikuZ2V0KCdfcmVzdWx0JyksXG4gICAgICAgICAgICBNYXAoKVxuICAgICAgICApLFxuICAgICAgICAnX3Jlc3VsdCBpcyBlbXB0eSAgd2hlbiByZWR1Y2VyIGlzIGNhbGxlZCB3aXRoIG5vIGV4aXN0aW5nIHN0YXRlJ1xuICAgICk7XG5cbiAgICB0dC50cnVlKFxuICAgICAgICBFbnRpdHlSZWR1Y2VyKHVuZGVmaW5lZCwge3R5cGU6ICdURVNUX0ZFVENIJ30pXG4gICAgICAgICAgICAuZ2V0SW4oWydfcmVxdWVzdFN0YXRlJywgJ1RFU1RfRkVUQ0gnLCAnZmV0Y2gnXSksXG4gICAgICAgICdfcmVxdWVzdFN0YXRlLmZldGNoIGlzIHRydWUgd2hlbiBhY3Rpb24gdHlwZSBlbmRzIHdpdGggX0ZFVENIJ1xuICAgICk7XG5cbiAgICB0dC5mYWxzZShcbiAgICAgICAgRW50aXR5UmVkdWNlcih1bmRlZmluZWQsIGV4YW1wbGVBY3Rpb24pXG4gICAgICAgICAgICAuZ2V0SW4oWydfcmVxdWVzdFN0YXRlJywgJ215VHlwZScsICdmZXRjaCddKSxcbiAgICAgICAgJ19yZXF1ZXN0U3RhdGUuZmV0Y2ggaXMgZmFsc2Ugd2hlbiBhY3Rpb24gdHlwZSBkb2VzIG5vdCBlbmQgd2l0aCBfRkVUQ0gnXG4gICAgKTtcblxuICAgIHR0LmlzKFxuICAgICAgICBFbnRpdHlSZWR1Y2VyKHVuZGVmaW5lZCwge3R5cGU6ICdURVNUX0VSUk9SJywgcGF5bG9hZDogJ2Vycm9yUGF5bG9hZCd9KVxuICAgICAgICAgICAgLmdldEluKFsnX3JlcXVlc3RTdGF0ZScsICdURVNUX0VSUk9SJywgJ2Vycm9yJ10pLFxuICAgICAgICAnZXJyb3JQYXlsb2FkJyxcbiAgICAgICAgJ19yZXF1ZXN0U3RhdGUuZXJyb3IgZXF1YWxzIHBheWxvYWQgd2hlbiBhY3Rpb24gdHlwZSBlbmRzIHdpdGggX0VSUk9SJ1xuICAgICk7XG5cbiAgICB0dC5pcyhcbiAgICAgICAgRW50aXR5UmVkdWNlcih1bmRlZmluZWQsIGV4YW1wbGVBY3Rpb24pXG4gICAgICAgICAgICAuZ2V0SW4oWydfcmVxdWVzdFN0YXRlJywgJ215VHlwZScsICdlcnJvciddKSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgJ19yZXF1ZXN0U3RhdGUuZXJyb3IgZXF1YWxzIGlzIG51bGwgd2hlbiBhY3Rpb24gdHlwZSBkb2VzIG5vdCBlbmQgd2l0aCBfRVJST1InXG4gICAgKTtcblxuICAgIGNvbnN0IGV4YW1wbGVTdGF0ZSA9IGZyb21KUyh7XG4gICAgICAgIHRoaW5nOiB7XG4gICAgICAgICAgICBhYmM6ICcxMjMnXG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHR0LnRydWUoXG4gICAgICAgIGlzKFxuICAgICAgICAgICAgRW50aXR5UmVkdWNlcihleGFtcGxlU3RhdGUsIGV4YW1wbGVBY3Rpb24pLmdldCgndGhpbmcnKSxcbiAgICAgICAgICAgIGZyb21KUyh7YWJjOiAnMTIzJ30pXG4gICAgICAgICksXG4gICAgICAgICdkYXRhIG9uIHN0YXRlIGlzIHVuY2hhbmdlZCB3aGVuIG5vdCByZWNlaXZpbmcgZGF0YSdcbiAgICApO1xuXG4gICAgY29uc3QgZXhhbXBsZVN0YXRlV2l0aFJlc3VsdHMgPSBmcm9tSlMoe1xuICAgICAgICB0aGluZzoge1xuICAgICAgICAgICAgYWJjOiAnMTIzJ1xuICAgICAgICB9LFxuICAgICAgICBfcmVzdWx0OiB7XG4gICAgICAgICAgICBURVNUX0ZFVENIOiBbXG4gICAgICAgICAgICAgICAgJ3h5eidcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBURVNUX09USEVSX0ZFVENIOiBbXG4gICAgICAgICAgICAgICAgJ3h5eidcbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBFbnRpdHlSZWR1Y2VyKGV4YW1wbGVTdGF0ZVdpdGhSZXN1bHRzLCBleGFtcGxlQWN0aW9uKS5nZXQoJ19yZXN1bHQnKSxcbiAgICAgICAgICAgIGV4YW1wbGVTdGF0ZVdpdGhSZXN1bHRzLmdldCgnX3Jlc3VsdCcpXG4gICAgICAgICksXG4gICAgICAgICdzdGF0ZS5fcmVzdWx0IGlzIHVuY2hhbmdlZCB3aGVuIG5vdCByZWNlaXZpbmcgZGF0YSdcbiAgICApO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBFbnRpdHlSZWR1Y2VyKGV4YW1wbGVTdGF0ZVdpdGhSZXN1bHRzLCB7dHlwZTogJ1RFU1RfRkVUQ0gnfSkuZ2V0KCdfcmVzdWx0JyksXG4gICAgICAgICAgICBleGFtcGxlU3RhdGVXaXRoUmVzdWx0cy5nZXQoJ19yZXN1bHQnKS5kZWxldGUoJ1RFU1RfRkVUQ0gnKVxuICAgICAgICApLFxuICAgICAgICAnc3RhdGUuX3Jlc3VsdC5UWVBFIGlzIGRlbGV0ZWQgd2hlbiBUWVBFIGlzIGZldGNoZWQnXG4gICAgKTtcblxuICAgIGNvbnN0IGV4YW1wbGVBY3Rpb25Ob1Jlc3VsdFJlc2V0ID0ge1xuICAgICAgICB0eXBlOiAnVEVTVF9GRVRDSCcsXG4gICAgICAgIG1ldGE6IHtcbiAgICAgICAgICAgIHJlc3VsdFJlc2V0T25GZXRjaDogZmFsc2VcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0dC50cnVlKFxuICAgICAgICBpcyhcbiAgICAgICAgICAgIEVudGl0eVJlZHVjZXIoZXhhbXBsZVN0YXRlV2l0aFJlc3VsdHMsIGV4YW1wbGVBY3Rpb25Ob1Jlc3VsdFJlc2V0KS5nZXQoJ19yZXN1bHQnKSxcbiAgICAgICAgICAgIGV4YW1wbGVTdGF0ZVdpdGhSZXN1bHRzLmdldCgnX3Jlc3VsdCcpXG4gICAgICAgICksXG4gICAgICAgICdzdGF0ZS5fcmVzdWx0LlRZUEUgaXMgdW5jaGFuZ2VkIHdoZW4gYSB0eXBlIGlzIGZldGNoZWQgQU5EIG1ldGEucmVzdWx0UmVzZXRPbkZldGNoIGlzIHRydWUnXG4gICAgKTtcblxuICAgIGNvbnN0IGV4YW1wbGVQYXlsb2FkID0ge1xuICAgICAgICBzdWJyZWRkaXQ6IHtcbiAgICAgICAgICAgIG5hbWU6IFwiTWVjaGFuaWNhbEtleWJvYXJkc1wiLFxuICAgICAgICAgICAgZnVsbG5hbWVJZDogXCJNS1wiLFxuICAgICAgICAgICAgdG9wTGlzdGluZ3M6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiZnVsbG5hbWVJZFwiOiBcIkNUXCIsXG4gICAgICAgICAgICAgICAgICAgIFwidGl0bGVcIjogXCJDb29sIHRpdGxlXCJcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJmdWxsbmFtZUlkXCI6IFwiTlRcIixcbiAgICAgICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIk5pY2UgdGl0bGVcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBleGFtcGxlUmVjZWl2ZUFjdGlvbiA9IHtcbiAgICAgICAgdHlwZTogJ1RFU1RfUkVDRUlWRScsXG4gICAgICAgIHBheWxvYWQ6IGV4YW1wbGVQYXlsb2FkXG4gICAgfTtcblxuICAgIHR0LmlzKFxuICAgICAgICBFbnRpdHlSZWR1Y2VyKGV4YW1wbGVTdGF0ZSwgZXhhbXBsZVJlY2VpdmVBY3Rpb24pLmdldEluKFsnX3Jlc3VsdCcsICdURVNUX1JFQ0VJVkUnLCAnc3VicmVkZGl0J10pLFxuICAgICAgICAnTUsnLFxuICAgICAgICAnTm9ybWFsaXplZCByZXN1bHRzIGFyZSBzdG9yZWQgaW4gc3RhdGUgdW5kZXIgX3Jlc3VsdC5BQ1RJT05OQU1FLktFWSdcbiAgICApO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBFbnRpdHlSZWR1Y2VyKGV4YW1wbGVTdGF0ZSwgZXhhbXBsZVJlY2VpdmVBY3Rpb24pLmdldEluKFsnc3VicmVkZGl0JywgJ01LJ10pLmRlbGV0ZSgndG9wTGlzdGluZ3MnKSxcbiAgICAgICAgICAgIGZyb21KUyhleGFtcGxlUGF5bG9hZC5zdWJyZWRkaXQpLmRlbGV0ZSgndG9wTGlzdGluZ3MnKVxuICAgICAgICApLFxuICAgICAgICAnTm9ybWFsaXplZCBlbnRpdGllcyBhcmUgc3RvcmVkIGluIHN0YXRlIHVuZGVyIEVOVElUWU5BTUUuSUQnXG4gICAgKTtcblxuICAgIHR0LnRydWUoXG4gICAgICAgIGlzKFxuICAgICAgICAgICAgRW50aXR5UmVkdWNlcihleGFtcGxlU3RhdGUsIGV4YW1wbGVSZWNlaXZlQWN0aW9uKS5nZXRJbihbJ3RvcExpc3RpbmdzJywgJ05UJ10pLFxuICAgICAgICAgICAgZnJvbUpTKGV4YW1wbGVQYXlsb2FkLnN1YnJlZGRpdC50b3BMaXN0aW5nc1sxXSlcbiAgICAgICAgKSxcbiAgICAgICAgJ05vcm1hbGl6ZWQgbmVzdGVkIGVudGl0aWVzIGFyZSBzdG9yZWQgaW4gc3RhdGUgdW5kZXIgRU5USVRZTkFNRS5JRCdcbiAgICApO1xuXG4gICAgY29uc3QgbWVyZ2VFeGFtcGxlUGF5bG9hZE9uZSA9IHtcbiAgICAgICAgc3VicmVkZGl0OiB7XG4gICAgICAgICAgICBuYW1lOiBcIk1lY2hhbmljYWxLZXlib2FyZHNcIixcbiAgICAgICAgICAgIGNvZGU6IFwiMTIzXCIsXG4gICAgICAgICAgICBmdWxsbmFtZUlkOiBcIk1LXCIsXG4gICAgICAgICAgICB0b3BMaXN0aW5nczogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgXCJmdWxsbmFtZUlkXCI6IFwiQ1RcIixcbiAgICAgICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIkNvb2wgdGl0bGVcIlxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBcImZ1bGxuYW1lSWRcIjogXCJOVFwiLFxuICAgICAgICAgICAgICAgICAgICBcInRpdGxlXCI6IFwiTmljZSB0aXRsZVwiXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXVxuICAgICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IG1lcmdlRXhhbXBsZVJlY2VpdmVBY3Rpb25PbmUgPSB7XG4gICAgICAgIHR5cGU6ICdURVNUX1JFQ0VJVkUnLFxuICAgICAgICBwYXlsb2FkOiBtZXJnZUV4YW1wbGVQYXlsb2FkT25lXG4gICAgfTtcblxuICAgIGNvbnN0IG1lcmdlRXhhbXBsZVBheWxvYWRUd28gPSB7XG4gICAgICAgIHN1YnJlZGRpdDoge1xuICAgICAgICAgICAgbmFtZTogXCJNZWNoYW5pY2FsS2V5Ym9hcmRzIVwiLFxuICAgICAgICAgICAgZnVsbG5hbWVJZDogXCJNS1wiLFxuICAgICAgICAgICAgdG9wTGlzdGluZ3M6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiZnVsbG5hbWVJZFwiOiBcIk5UXCIsXG4gICAgICAgICAgICAgICAgICAgIFwidGl0bGVcIjogXCJOaWNlIHRpdGxlIVwiXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiZnVsbG5hbWVJZFwiOiBcIkdMXCIsXG4gICAgICAgICAgICAgICAgICAgIFwidGl0bGVcIjogXCJHb29kIGx1Y2tcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF1cbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBtZXJnZUV4YW1wbGVSZWNlaXZlQWN0aW9uVHdvID0ge1xuICAgICAgICB0eXBlOiAnVEVTVF9SRUNFSVZFJyxcbiAgICAgICAgcGF5bG9hZDogbWVyZ2VFeGFtcGxlUGF5bG9hZFR3b1xuICAgIH07XG5cbiAgICBjb25zdCBtZXJnZVN0YXRlT25lID0gRW50aXR5UmVkdWNlcihleGFtcGxlU3RhdGUsIG1lcmdlRXhhbXBsZVJlY2VpdmVBY3Rpb25PbmUpO1xuICAgIGNvbnN0IG1lcmdlU3RhdGVUd28gPSBFbnRpdHlSZWR1Y2VyKG1lcmdlU3RhdGVPbmUsIG1lcmdlRXhhbXBsZVJlY2VpdmVBY3Rpb25Ud28pO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBtZXJnZVN0YXRlVHdvLmdldEluKFsnc3VicmVkZGl0JywgJ01LJ10pLmRlbGV0ZSgndG9wTGlzdGluZ3MnKSxcbiAgICAgICAgICAgIGZyb21KUyhtZXJnZUV4YW1wbGVQYXlsb2FkVHdvLnN1YnJlZGRpdCkuZGVsZXRlKCd0b3BMaXN0aW5ncycpXG4gICAgICAgICksXG4gICAgICAgICdSZWNlaXZpbmcgdXBkYXRlZCBpbmZvIGZvciBhbiBlbnRpdHkgd2lsbCByZXBsYWNlIGVudGl0eSBkYXRhJ1xuICAgICk7XG5cbiAgICB0dC50cnVlKFxuICAgICAgICBpcyhcbiAgICAgICAgICAgIG1lcmdlU3RhdGVUd28uZ2V0SW4oWyd0b3BMaXN0aW5ncycsICdOVCddKSxcbiAgICAgICAgICAgIGZyb21KUyhtZXJnZUV4YW1wbGVQYXlsb2FkVHdvLnN1YnJlZGRpdC50b3BMaXN0aW5nc1swXSlcbiAgICAgICAgKSxcbiAgICAgICAgJ1JlY2VpdmluZyB1cGRhdGVkIGluZm8gZm9yIGFuIGVudGl0eSB3aWxsIHJlcGxhY2UgbmVzdGVkIGVudGl0eSBkYXRhJ1xuICAgICk7XG5cbiAgICB0dC50cnVlKFxuICAgICAgICBpcyhcbiAgICAgICAgICAgIG1lcmdlU3RhdGVUd28uZ2V0SW4oWyd0b3BMaXN0aW5ncycsICdDVCddKSxcbiAgICAgICAgICAgIGZyb21KUyhtZXJnZUV4YW1wbGVQYXlsb2FkT25lLnN1YnJlZGRpdC50b3BMaXN0aW5nc1swXSlcbiAgICAgICAgKSxcbiAgICAgICAgJ09uY2UgYW4gZW50aXR5IGlzIHJlY2VpdmVkLCBpdHMgZW50aXR5IGRhdGEgaXMgcmV0YWluZWQgZXZlbiBpZiBzdWJzZXF1ZW50IHJlY2VpdmVkIGVudGl0aWVzIGRvbnQgY29udGFpbiBpdCdcbiAgICApO1xuXG4gICAgdHQudHJ1ZShcbiAgICAgICAgaXMoXG4gICAgICAgICAgICBtZXJnZVN0YXRlVHdvLmdldEluKFsndG9wTGlzdGluZ3MnLCAnR0wnXSksXG4gICAgICAgICAgICBmcm9tSlMobWVyZ2VFeGFtcGxlUGF5bG9hZFR3by5zdWJyZWRkaXQudG9wTGlzdGluZ3NbMV0pXG4gICAgICAgICksXG4gICAgICAgICdOZXdseSByZWNlaXZlZCBuZXN0ZWQgZW50aXRlcyBhcmUgbWVyZ2VkIGludG8gdGhlaXIgZW50aXR5IGNvbnRhaW5lcidcbiAgICApO1xuXG59KTtcbiJdfQ==